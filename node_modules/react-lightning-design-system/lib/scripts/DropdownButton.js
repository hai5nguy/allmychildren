'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _objectWithoutProperties2 = require('babel-runtime/helpers/objectWithoutProperties');

var _objectWithoutProperties3 = _interopRequireDefault(_objectWithoutProperties2);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactDom = require('react-dom');

var _reactDom2 = _interopRequireDefault(_reactDom);

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

var _Button = require('./Button');

var _Button2 = _interopRequireDefault(_Button);

var _DropdownMenu = require('./DropdownMenu');

var _DropdownMenu2 = _interopRequireDefault(_DropdownMenu);

var _util = require('./util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var DropdownButton = function (_React$Component) {
  (0, _inherits3.default)(DropdownButton, _React$Component);

  function DropdownButton(props) {
    (0, _classCallCheck3.default)(this, DropdownButton);

    var _this = (0, _possibleConstructorReturn3.default)(this, (0, _getPrototypeOf2.default)(DropdownButton).call(this, props));

    _this.state = { opened: false };
    (0, _util.registerStyle)('no-hover-popup', [['.slds-dropdown-trigger:hover .slds-dropdown--menu.react-slds-no-hover-popup', '{ visibility: hidden; opacity: 0; }'], ['.slds-dropdown-trigger.react-slds-dropdown-opened .slds-dropdown--menu', '{ visibility: visible !important; opacity: 1 !important; }']]);
    return _this;
  }

  (0, _createClass3.default)(DropdownButton, [{
    key: 'onBlur',
    value: function onBlur() {
      var _this2 = this;

      setTimeout(function () {
        if (!_this2.isFocusedInComponent()) {
          _this2.setState({ opened: false });
          if (_this2.props.onBlur) {
            _this2.props.onBlur();
          }
        }
      }, 10);
    }
  }, {
    key: 'onKeyDown',
    value: function onKeyDown(e) {
      var _this3 = this;

      if (e.keyCode === 40) {
        // down
        e.preventDefault();
        e.stopPropagation();
        if (!this.state.opened) {
          this.setState({ opened: true });
          setTimeout(function () {
            _this3.focusToTargetItemEl();
          }, 20);
        } else {
          this.focusToTargetItemEl();
        }
      } else if (e.keyCode === 27) {
        // ESC
        e.preventDefault();
        e.stopPropagation();
        this.setState({ opened: false });
      }
    }
  }, {
    key: 'onTriggerClick',
    value: function onTriggerClick() {
      if (!this.props.hoverPopup) {
        this.setState({ opened: !this.state.opened });
      }
      if (this.props.onClick) {
        var _props;

        (_props = this.props).onClick.apply(_props, arguments);
      }
    }
  }, {
    key: 'onMenuItemClick',
    value: function onMenuItemClick() {
      var _this4 = this;

      if (!this.props.hoverPopup) {
        setTimeout(function () {
          var triggerElem = _reactDom2.default.findDOMNode(_this4.refs.trigger);
          if (triggerElem) triggerElem.focus();
          _this4.setState({ opened: false });
        }, 10);
      }
      if (this.props.onMenuItemClick) {
        var _props2;

        (_props2 = this.props).onMenuItemClick.apply(_props2, arguments);
      }
    }
  }, {
    key: 'onMenuClose',
    value: function onMenuClose() {
      var triggerElem = _reactDom2.default.findDOMNode(this.refs.trigger);
      triggerElem.focus();
      this.setState({ opened: false });
    }
  }, {
    key: 'isFocusedInComponent',
    value: function isFocusedInComponent() {
      var rootEl = _reactDom2.default.findDOMNode(this);
      var targetEl = document.activeElement;
      while (targetEl && targetEl !== rootEl) {
        targetEl = targetEl.parentNode;
      }
      return !!targetEl;
    }
  }, {
    key: 'focusToTargetItemEl',
    value: function focusToTargetItemEl() {
      var dropdownEl = _reactDom2.default.findDOMNode(this.refs.dropdown);
      var firstItemEl = dropdownEl.querySelector('.slds-is-selected > .react-slds-menuitem[tabIndex]') || dropdownEl.querySelector('.react-slds-menuitem[tabIndex]');
      if (firstItemEl) {
        firstItemEl.focus();
      }
    }
  }, {
    key: 'renderButton',
    value: function renderButton(_ref) {
      var grouped = _ref.grouped;
      var isFirstInGroup = _ref.isFirstInGroup;
      var isLastInGroup = _ref.isLastInGroup;
      var props = (0, _objectWithoutProperties3.default)(_ref, ['grouped', 'isFirstInGroup', 'isLastInGroup']);

      if (grouped) {
        var noneStyle = { display: 'none' };
        return _react2.default.createElement(
          'div',
          { className: 'slds-button-group' },
          isFirstInGroup ? null : _react2.default.createElement('button', { className: 'slds-button', style: noneStyle }),
          _react2.default.createElement(_Button2.default, (0, _extends3.default)({}, props, { 'aria-haspopup': true,
            ref: 'trigger',
            onClick: this.onTriggerClick.bind(this),
            onKeyDown: this.onKeyDown.bind(this),
            onBlur: this.onBlur.bind(this)
          })),
          isLastInGroup ? null : _react2.default.createElement('button', { className: 'slds-button', style: noneStyle })
        );
      }

      return _react2.default.createElement(_Button2.default, (0, _extends3.default)({}, props, { 'aria-haspopup': true,
        ref: 'trigger',
        onClick: this.onTriggerClick.bind(this),
        onKeyDown: this.onKeyDown.bind(this),
        onBlur: this.onBlur.bind(this)
      }));
    }
  }, {
    key: 'render',
    value: function render() {
      var _props3 = this.props;
      var className = _props3.className;
      var _props3$menuAlign = _props3.menuAlign;
      var menuAlign = _props3$menuAlign === undefined ? 'left' : _props3$menuAlign;
      var menuSize = _props3.menuSize;
      var nubbinTop = _props3.nubbinTop;
      var hoverPopup = _props3.hoverPopup;
      var menuHeader = _props3.menuHeader;
      var type = _props3.type;
      var label = _props3.label;
      var children = _props3.children;
      var props = (0, _objectWithoutProperties3.default)(_props3, ['className', 'menuAlign', 'menuSize', 'nubbinTop', 'hoverPopup', 'menuHeader', 'type', 'label', 'children']);
      var icon = this.props.icon;

      var dropdownClassNames = (0, _classnames2.default)(className, 'slds-dropdown-trigger', { 'react-slds-dropdown-opened': this.state.opened });
      var iconMore = null;
      if (!label && !icon) {
        icon = 'down';
      }
      if (label || type === 'icon-more') {
        iconMore = 'down';
      }
      return _react2.default.createElement(
        'div',
        { className: dropdownClassNames },
        this.renderButton((0, _extends3.default)({ type: type, label: label, icon: icon, iconMore: iconMore }, props)),
        _react2.default.createElement(
          _DropdownMenu2.default,
          { align: menuAlign, header: menuHeader, size: menuSize,
            nubbinTop: nubbinTop, hoverPopup: hoverPopup,
            ref: 'dropdown',
            onMenuItemClick: this.onMenuItemClick.bind(this),
            onMenuClose: this.onMenuClose.bind(this),
            onBlur: this.onBlur.bind(this)
          },
          children
        )
      );
    }
  }]);
  return DropdownButton;
}(_react2.default.Component);

exports.default = DropdownButton;


DropdownButton.propTypes = {
  className: _react.PropTypes.string,
  label: _react.PropTypes.string,
  type: _react.PropTypes.string,
  icon: _react.PropTypes.string,
  menuAlign: _react.PropTypes.oneOf(['left', 'center', 'right']),
  menuSize: _react.PropTypes.oneOf(['small', 'medium', 'large']),
  menuHeader: _react.PropTypes.string,
  nubbinTop: _react.PropTypes.bool,
  hoverPopup: _react.PropTypes.bool,
  onBlur: _react.PropTypes.func,
  onClick: _react.PropTypes.func,
  onMenuItemClick: _react.PropTypes.func,
  grouped: _react.PropTypes.bool,
  isFirstInGroup: _react.PropTypes.bool,
  isLastInGroup: _react.PropTypes.bool,
  children: _react.PropTypes.node
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JpcHRzL0Ryb3Bkb3duQnV0dG9uLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFPcUI7OztBQUNuQixXQURtQixjQUNuQixDQUFZLEtBQVosRUFBbUI7d0NBREEsZ0JBQ0E7OzZGQURBLDJCQUVYLFFBRFc7O0FBRWpCLFVBQUssS0FBTCxHQUFhLEVBQUUsUUFBUSxLQUFSLEVBQWYsQ0FGaUI7QUFHakIsNkJBQWMsZ0JBQWQsRUFBZ0MsQ0FDOUIsQ0FDRSw2RUFERixFQUVFLHFDQUZGLENBRDhCLEVBSzlCLENBQ0Usd0VBREYsRUFFRSw0REFGRixDQUw4QixDQUFoQyxFQUhpQjs7R0FBbkI7OzZCQURtQjs7NkJBZ0JWOzs7QUFDUCxpQkFBVyxZQUFNO0FBQ2YsWUFBSSxDQUFDLE9BQUssb0JBQUwsRUFBRCxFQUE4QjtBQUNoQyxpQkFBSyxRQUFMLENBQWMsRUFBRSxRQUFRLEtBQVIsRUFBaEIsRUFEZ0M7QUFFaEMsY0FBSSxPQUFLLEtBQUwsQ0FBVyxNQUFYLEVBQW1CO0FBQ3JCLG1CQUFLLEtBQUwsQ0FBVyxNQUFYLEdBRHFCO1dBQXZCO1NBRkY7T0FEUyxFQU9SLEVBUEgsRUFETzs7Ozs4QkFXQyxHQUFHOzs7QUFDWCxVQUFJLEVBQUUsT0FBRixLQUFjLEVBQWQsRUFBa0I7O0FBQ3BCLFVBQUUsY0FBRixHQURvQjtBQUVwQixVQUFFLGVBQUYsR0FGb0I7QUFHcEIsWUFBSSxDQUFDLEtBQUssS0FBTCxDQUFXLE1BQVgsRUFBbUI7QUFDdEIsZUFBSyxRQUFMLENBQWMsRUFBRSxRQUFRLElBQVIsRUFBaEIsRUFEc0I7QUFFdEIscUJBQVcsWUFBTTtBQUNmLG1CQUFLLG1CQUFMLEdBRGU7V0FBTixFQUVSLEVBRkgsRUFGc0I7U0FBeEIsTUFLTztBQUNMLGVBQUssbUJBQUwsR0FESztTQUxQO09BSEYsTUFXTyxJQUFJLEVBQUUs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VTtFQUF1QixnQkFBTSxTQUFOOztrQkFBdkI7OztBQXlKckIsZUFBZSxTQUFmLEdBQTJCO0FBQ3pCLGFBQVcsaUJBQVUsTUFBVjtBQUNYLFNBQU8saUJBQVUsTUFBVjtBQUNQLFFBQU0saUJBQVUsTUFBVjtBQUNOLFFBQU0saUJBQVUsTUFBVjtBQUNOLGFBQVcsaUJBQVUsS0FBVixDQUFnQixDQUFDLE1BQUQsRUFBUyxRQUFULEVBQW1CLE9BQW5CLENBQWhCLENBQVg7QUFDQSxZQUFVLGlCQUFVLEtBQVYsQ0FBZ0IsQ0FBQyxPQUFELEVBQVUsUUFBVixFQUFvQixPQUFwQixDQUFoQixDQUFWO0FBQ0EsY0FBWSxpQkFBVSxNQUFWO0FBQ1osYUFBVyxpQkFBVSxJQUFWO0FBQ1gsY0FBWSxpQkFBVSxJQUFWO0FBQ1osVUFBUSxpQkFBVSxJQUFWO0FBQ1IsV0FBUyxpQkFBVSxJQUFWO0FBQ1QsbUJBQWlCLGlCQUFVLElBQVY7QUFDakIsV0FBUyxpQkFBVSxJQUFWO0FBQ1Qsa0JBQWdCLGlCQUFVLElBQVY7QUFDaEIsaUJBQWUsaUJBQVUsSUFBVjtBQUNmLFlBQVUsaUJBQVUsSUFBVjtDQWhCWiIsImZpbGUiOiJEcm9wZG93bkJ1dHRvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBQcm9wVHlwZXMgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUmVhY3RET00gZnJvbSAncmVhY3QtZG9tJztcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xuaW1wb3J0IEJ1dHRvbiBmcm9tICcuL0J1dHRvbic7XG5pbXBvcnQgRHJvcGRvd25NZW51IGZyb20gJy4vRHJvcGRvd25NZW51JztcbmltcG9ydCB7IHJlZ2lzdGVyU3R5bGUgfSBmcm9tICcuL3V0aWwnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBEcm9wZG93bkJ1dHRvbiBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuICAgIHRoaXMuc3RhdGUgPSB7IG9wZW5lZDogZmFsc2UgfTtcbiAgICByZWdpc3RlclN0eWxlKCduby1ob3Zlci1wb3B1cCcsIFtcbiAgICAgIFtcbiAgICAgICAgJy5zbGRzLWRyb3Bkb3duLXRyaWdnZXI6aG92ZXIgLnNsZHMtZHJvcGRvd24tLW1lbnUucmVhY3Qtc2xkcy1uby1ob3Zlci1wb3B1cCcsXG4gICAgICAgICd7IHZpc2liaWxpdHk6IGhpZGRlbjsgb3BhY2l0eTogMDsgfScsXG4gICAgICBdLFxuICAgICAgW1xuICAgICAgICAnLnNsZHMtZHJvcGRvd24tdHJpZ2dlci5yZWFjdC1zbGRzLWRyb3Bkb3duLW9wZW5lZCAuc2xkcy1kcm9wZG93bi0tbWVudScsXG4gICAgICAgICd7IHZpc2liaWxpdHk6IHZpc2libGUgIWltcG9ydGFudDsgb3BhY2l0eTogMSAhaW1wb3J0YW50OyB9JyxcbiAgICAgIF0sXG4gICAgXSk7XG4gIH1cblxuICBvbkJsdXIoKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMuaXNGb2N1c2VkSW5Db21wb25lbnQoKSkge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgb3BlbmVkOiBmYWxzZSB9KTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMub25CbHVyKSB7XG4gICAgICAgICAgdGhpcy5wcm9wcy5vbkJsdXIoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sIDEwKTtcbiAgfVxuXG4gIG9uS2V5RG93bihlKSB7XG4gICAgaWYgKGUua2V5Q29kZSA9PT0gNDApIHsgLy8gZG93blxuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIGlmICghdGhpcy5zdGF0ZS5vcGVuZWQpIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IG9wZW5lZDogdHJ1ZSB9KTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5mb2N1c1RvVGFyZ2V0SXRlbUVsKCk7XG4gICAgICAgIH0sIDIwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZm9jdXNUb1RhcmdldEl0ZW1FbCgpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZS5rZXlDb2RlID09PSAyNykgeyAvLyBFU0NcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgb3BlbmVkOiBmYWxzZSB9KTtcbiAgICB9XG4gIH1cblxuICBvblRyaWdnZXJDbGljayguLi5hcmdzKSB7XG4gICAgaWYgKCF0aGlzLnByb3BzLmhvdmVyUG9wdXApIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoeyBvcGVuZWQ6ICF0aGlzLnN0YXRlLm9wZW5lZCB9KTtcbiAgICB9XG4gICAgaWYgKHRoaXMucHJvcHMub25DbGljaykge1xuICAgICAgdGhpcy5wcm9wcy5vbkNsaWNrKC4uLmFyZ3MpO1xuICAgIH1cbiAgfVxuXG4gIG9uTWVudUl0ZW1DbGljayguLi5hcmdzKSB7XG4gICAgaWYgKCF0aGlzLnByb3BzLmhvdmVyUG9wdXApIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb25zdCB0cmlnZ2VyRWxlbSA9IFJlYWN0RE9NLmZpbmRET01Ob2RlKHRoaXMucmVmcy50cmlnZ2VyKTtcbiAgICAgICAgaWYgKHRyaWdnZXJFbGVtKSB0cmlnZ2VyRWxlbS5mb2N1cygpO1xuICAgICAgICB0aGlzLnNldFN0YXRlKHsgb3BlbmVkOiBmYWxzZSB9KTtcbiAgICAgIH0sIDEwKTtcbiAgICB9XG4gICAgaWYgKHRoaXMucHJvcHMub25NZW51SXRlbUNsaWNrKSB7XG4gICAgICB0aGlzLnByb3BzLm9uTWVudUl0ZW1DbGljayguLi5hcmdzKTtcbiAgICB9XG4gIH1cblxuICBvbk1lbnVDbG9zZSgpIHtcbiAgICBjb25zdCB0cmlnZ2VyRWxlbSA9IFJlYWN0RE9NLmZpbmRET01Ob2RlKHRoaXMucmVmcy50cmlnZ2VyKTtcbiAgICB0cmlnZ2VyRWxlbS5mb2N1cygpO1xuICAgIHRoaXMuc2V0U3RhdGUoeyBvcGVuZWQ6IGZhbHNlIH0pO1xuICB9XG5cbiAgaXNGb2N1c2VkSW5Db21wb25lbnQoKSB7XG4gICAgY29uc3Qgcm9vdEVsID0gUmVhY3RET00uZmluZERPTU5vZGUodGhpcyk7XG4gICAgbGV0IHRhcmdldEVsID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcbiAgICB3aGlsZSAodGFyZ2V0RWwgJiYgdGFyZ2V0RWwgIT09IHJvb3RFbCkge1xuICAgICAgdGFyZ2V0RWwgPSB0YXJnZXRFbC5wYXJlbnROb2RlO1xuICAgIH1cbiAgICByZXR1cm4gISF0YXJnZXRFbDtcbiAgfVxuXG4gIGZvY3VzVG9UYXJnZXRJdGVtRWwoKSB7XG4gICAgY29uc3QgZHJvcGRvd25FbCA9IFJlYWN0RE9NLmZpbmRET01Ob2RlKHRoaXMucmVmcy5kcm9wZG93bik7XG4gICAgY29uc3QgZmlyc3RJdGVtRWwgPVxuICAgICAgZHJvcGRvd25FbC5xdWVyeVNlbGVjdG9yKCcuc2xkcy1pcy1zZWxlY3RlZCA+IC5yZWFjdC1zbGRzLW1lbnVpdGVtW3RhYkluZGV4XScpIHx8XG4gICAgICBkcm9wZG93bkVsLnF1ZXJ5U2VsZWN0b3IoJy5yZWFjdC1zbGRzLW1lbnVpdGVtW3RhYkluZGV4XScpO1xuICAgIGlmIChmaXJzdEl0ZW1FbCkge1xuICAgICAgZmlyc3RJdGVtRWwuZm9jdXMoKTtcbiAgICB9XG4gIH1cblxuICByZW5kZXJCdXR0b24oeyBncm91cGVkLCBpc0ZpcnN0SW5Hcm91cCwgaXNMYXN0SW5Hcm91cCwgLi4ucHJvcHMgfSkge1xuICAgIGlmIChncm91cGVkKSB7XG4gICAgICBjb25zdCBub25lU3R5bGUgPSB7IGRpc3BsYXk6ICdub25lJyB9O1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NsZHMtYnV0dG9uLWdyb3VwJz5cbiAgICAgICAgICB7IGlzRmlyc3RJbkdyb3VwID8gbnVsbCA6IDxidXR0b24gY2xhc3NOYW1lPSdzbGRzLWJ1dHRvbicgc3R5bGU9eyBub25lU3R5bGUgfT48L2J1dHRvbj4gfVxuICAgICAgICAgIDxCdXR0b24geyAuLi5wcm9wcyB9IGFyaWEtaGFzcG9wdXBcbiAgICAgICAgICAgIHJlZj0ndHJpZ2dlcidcbiAgICAgICAgICAgIG9uQ2xpY2s9eyB0aGlzLm9uVHJpZ2dlckNsaWNrLmJpbmQodGhpcykgfVxuICAgICAgICAgICAgb25LZXlEb3duPXsgdGhpcy5vbktleURvd24uYmluZCh0aGlzKSB9XG4gICAgICAgICAgICBvbkJsdXI9eyB0aGlzLm9uQmx1ci5iaW5kKHRoaXMpIH1cbiAgICAgICAgICAvPlxuICAgICAgICAgIHsgaXNMYXN0SW5Hcm91cCA/IG51bGwgOiA8YnV0dG9uIGNsYXNzTmFtZT0nc2xkcy1idXR0b24nIHN0eWxlPXsgbm9uZVN0eWxlIH0+PC9idXR0b24+IH1cbiAgICAgICAgPC9kaXY+XG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICA8QnV0dG9uIHsgLi4ucHJvcHMgfSBhcmlhLWhhc3BvcHVwXG4gICAgICAgIHJlZj0ndHJpZ2dlcidcbiAgICAgICAgb25DbGljaz17IHRoaXMub25UcmlnZ2VyQ2xpY2suYmluZCh0aGlzKSB9XG4gICAgICAgIG9uS2V5RG93bj17IHRoaXMub25LZXlEb3duLmJpbmQodGhpcykgfVxuICAgICAgICBvbkJsdXI9eyB0aGlzLm9uQmx1ci5iaW5kKHRoaXMpIH1cbiAgICAgIC8+XG4gICAgKTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IGNsYXNzTmFtZSwgbWVudUFsaWduID0gJ2xlZnQnLCBtZW51U2l6ZSwgbnViYmluVG9wLCBob3ZlclBvcHVwLCBtZW51SGVhZGVyLCB0eXBlLCBsYWJlbCwgY2hpbGRyZW4sIC4uLnByb3BzIH0gPSB0aGlzLnByb3BzO1xuICAgIGxldCB7IGljb24gfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgZHJvcGRvd25DbGFzc05hbWVzID0gY2xhc3NuYW1lcyhcbiAgICAgIGNsYXNzTmFtZSxcbiAgICAgICdzbGRzLWRyb3Bkb3duLXRyaWdnZXInLFxuICAgICAgeyAncmVhY3Qtc2xkcy1kcm9wZG93bi1vcGVuZWQnOiB0aGlzLnN0YXRlLm9wZW5lZCB9XG4gICAgKTtcbiAgICBsZXQgaWNvbk1vcmUgPSBudWxsO1xuICAgIGlmICghbGFiZWwgJiYgIWljb24pIHtcbiAgICAgIGljb24gPSAnZG93bic7XG4gICAgfVxuICAgIGlmIChsYWJlbCB8fCB0eXBlID09PSAnaWNvbi1tb3JlJykge1xuICAgICAgaWNvbk1vcmUgPSAnZG93bic7XG4gICAgfVxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT17IGRyb3Bkb3duQ2xhc3NOYW1lcyB9PlxuICAgICAgICB7IHRoaXMucmVuZGVyQnV0dG9uKHsgdHlwZSwgbGFiZWwsIGljb24sIGljb25Nb3JlLCAuLi5wcm9wcyB9KSB9XG4gICAgICAgIDxEcm9wZG93bk1lbnUgYWxpZ249eyBtZW51QWxpZ24gfSBoZWFkZXI9eyBtZW51SGVhZGVyIH0gc2l6ZT17IG1lbnVTaXplIH1cbiAgICAgICAgICBudWJiaW5Ub3A9eyBudWJiaW5Ub3AgfSBob3ZlclBvcHVwPXsgaG92ZXJQb3B1cCB9XG4gICAgICAgICAgcmVmPSdkcm9wZG93bidcbiAgICAgICAgICBvbk1lbnVJdGVtQ2xpY2s9eyB0aGlzLm9uTWVudUl0ZW1DbGljay5iaW5kKHRoaXMpIH1cbiAgICAgICAgICBvbk1lbnVDbG9zZT17IHRoaXMub25NZW51Q2xvc2UuYmluZCh0aGlzKSB9XG4gICAgICAgICAgb25CbHVyPXsgdGhpcy5vbkJsdXIuYmluZCh0aGlzKSB9XG4gICAgICAgID5cbiAgICAgICAgICB7IGNoaWxkcmVuIH1cbiAgICAgICAgPC9Ecm9wZG93bk1lbnU+XG4gICAgICA8L2Rpdj5cbiAgICApO1xuICB9XG5cbn1cblxuRHJvcGRvd25CdXR0b24ucHJvcFR5cGVzID0ge1xuICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gIGxhYmVsOiBQcm9wVHlwZXMuc3RyaW5nLFxuICB0eXBlOiBQcm9wVHlwZXMuc3RyaW5nLFxuICBpY29uOiBQcm9wVHlwZXMuc3RyaW5nLFxuICBtZW51QWxpZ246IFByb3BUeXBlcy5vbmVPZihbJ2xlZnQnLCAnY2VudGVyJywgJ3JpZ2h0J10pLFxuICBtZW51U2l6ZTogUHJvcFR5cGVzLm9uZU9mKFsnc21hbGwnLCAnbWVkaXVtJywgJ2xhcmdlJ10pLFxuICBtZW51SGVhZGVyOiBQcm9wVHlwZXMuc3RyaW5nLFxuICBudWJiaW5Ub3A6IFByb3BUeXBlcy5ib29sLFxuICBob3ZlclBvcHVwOiBQcm9wVHlwZXMuYm9vbCxcbiAgb25CbHVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgb25DbGljazogUHJvcFR5cGVzLmZ1bmMsXG4gIG9uTWVudUl0ZW1DbGljazogUHJvcFR5cGVzLmZ1bmMsXG4gIGdyb3VwZWQ6IFByb3BUeXBlcy5ib29sLFxuICBpc0ZpcnN0SW5Hcm91cDogUHJvcFR5cGVzLmJvb2wsXG4gIGlzTGFzdEluR3JvdXA6IFByb3BUeXBlcy5ib29sLFxuICBjaGlsZHJlbjogUHJvcFR5cGVzLm5vZGUsXG59O1xuIl19